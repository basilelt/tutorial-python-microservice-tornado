---
- name: Create kube directory
  ansible.builtin.file:
    path: "~/.kube"
    state: directory
    mode: '0700'

- name: Template admin.conf to kubeconfig
  ansible.builtin.template:
    src: "admin.conf.j2"
    dest: "~/.kube/config"
    mode: '0600'

- name: Print kubeconfig content for debugging
  ansible.builtin.command: cat ~/.kube/config
  register: kubeconfig_content
  changed_when: false

- name: Show kubeconfig content
  ansible.builtin.debug:
    var: kubeconfig_content.stdout_lines
    verbosity: 1

- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    kubeconfig: "~/.kube/config"
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ CI_ENVIRONMENT_SLUG }}"
